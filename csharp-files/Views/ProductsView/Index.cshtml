@model YameApi.Models.DTOs.ProductListResponse
@{
    ViewData["Title"] = "Sản phẩm";
}

<!-- Page Header -->
<div class="page-header">
    <div class="container">
        <h1 class="page-title">Sản phẩm</h1>
        <p class="section-subtitle">Khám phá toàn bộ bộ sưu tập của chúng tôi</p>
    </div>
</div>

<div class="container products-layout">
    <!-- Filters Sidebar -->
    <aside class="filters-sidebar hidden-mobile">
        <div>
            <h3 class="section-title" style="font-size: 1.125rem; margin-bottom: 1rem;">Bộ lọc</h3>
        </div>

        <!-- Price Range -->
        <div class="filter-section">
            <h4 class="filter-title">Khoảng giá</h4>
            <div class="filter-options">
                <label class="filter-option">
                    <input type="checkbox" class="filter-checkbox price-filter" data-min="0" data-max="200000" />
                    <span class="filter-label">Dưới 200.000đ</span>
                </label>
                <label class="filter-option">
                    <input type="checkbox" class="filter-checkbox price-filter" data-min="200000" data-max="500000" />
                    <span class="filter-label">200.000đ - 500.000đ</span>
                </label>
                <label class="filter-option">
                    <input type="checkbox" class="filter-checkbox price-filter" data-min="500000" data-max="1000000" />
                    <span class="filter-label">500.000đ - 1.000.000đ</span>
                </label>
                <label class="filter-option">
                    <input type="checkbox" class="filter-checkbox price-filter" data-min="1000000" data-max="999999999" />
                    <span class="filter-label">Trên 1.000.000đ</span>
                </label>
            </div>
        </div>

        <!-- Sizes -->
        <div class="filter-section">
            <h4 class="filter-title">Kích thước</h4>
            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                @foreach (var size in new[] { "S", "M", "L", "XL", "XXL" })
                {
                    <button class="btn size-filter" data-size="@size" style="padding: 0.5rem; width: 2.5rem; height: 2.5rem; border: 1px solid var(--border);">@size</button>
                }
            </div>
        </div>

        <!-- Colors -->
        <div class="filter-section">
            <h4 class="filter-title">Màu sắc</h4>
            <div class="filter-options">
                @foreach (var color in new[] { "Đen", "Trắng", "Xám", "Navy", "Vàng" })
                {
                    <label class="filter-option">
                        <input type="checkbox" class="filter-checkbox color-filter" data-color="@color" />
                        <span class="filter-label">@color</span>
                    </label>
                }
            </div>
        </div>

        <!-- Clear Filters -->
        <button id="clearFilters" class="btn btn-secondary" style="width: 100%; margin-top: 1rem;">Xóa bộ lọc</button>
    </aside>

    <!-- Products Content -->
    <div class="products-content">
        <!-- Toolbar -->
        <div class="products-toolbar">
            <p class="products-count">Hiển thị @Model.Items.Count() sản phẩm</p>
            
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <label for="sort" style="font-size: 0.875rem;">Sắp xếp:</label>
                <select id="sortSelect" class="sort-select">
                    <option value="relevance" @(ViewContext.HttpContext.Request.Query["sort"] == "relevance" || string.IsNullOrEmpty(ViewContext.HttpContext.Request.Query["sort"]) ? "selected" : "")>Phổ biến nhất</option>
                    <option value="price-asc" @(ViewContext.HttpContext.Request.Query["sort"] == "price-asc" ? "selected" : "")>Giá: Thấp đến cao</option>
                    <option value="price-desc" @(ViewContext.HttpContext.Request.Query["sort"] == "price-desc" ? "selected" : "")>Giá: Cao đến thấp</option>
                    <option value="newest" @(ViewContext.HttpContext.Request.Query["sort"] == "newest" ? "selected" : "")>Mới nhất</option>
                </select>
            </div>
        </div>

        <!-- Products Grid -->
        <div class="product-grid product-grid-3">
            @foreach (var product in Model.Items)
            {
                var hasDiscount = product.SalePrice.HasValue && product.SalePrice < product.Price;
                var discountPercent = hasDiscount ? Math.Round(((product.Price - product.SalePrice.Value) / product.Price) * 100) : 0;

                <div class="product-card">
                    <a href="/ProductsView/Detail/@product.Id">
                        <div class="product-image-wrapper">
                            <img src="@product.Images.FirstOrDefault()" alt="@product.Title" class="product-image" />
                            @if (hasDiscount)
                            {
                                <span class="product-badge badge-sale">-@discountPercent%</span>
                            }
                            @if (!product.Availability)
                            {
                                <div style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background-color: rgba(255, 255, 255, 0.8);">
                                    <span class="badge-secondary" style="padding: 0.5rem 1rem;">Hết hàng</span>
                                </div>
                            }
                        </div>
                        
                        <div class="product-info">
                            <div class="product-tags">
                                @foreach (var tag in product.Tags.Take(2))
                                {
                                    <span class="product-tag">@tag</span>
                                }
                            </div>
                            
                            <h3 class="product-title">@product.Title</h3>
                            
                            <p class="product-description">@product.ShortDescription</p>

                            <div class="product-price-wrapper">
                                <span class="product-price">
                                    @((product.SalePrice ?? product.Price).ToString("N0"))đ
                                </span>
                                @if (hasDiscount)
                                {
                                    <span class="product-price-old">@product.Price.ToString("N0")đ</span>
                                }
                            </div>
                        </div>
                    </a>
                    
                    <div class="product-quick-add">
                        <button class="btn btn-icon-only" onclick="event.preventDefault();">
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            }
        </div>

        <!-- Pagination -->
        <div class="pagination">
            <button class="pagination-btn" disabled>Trước</button>
            <button class="pagination-btn active">1</button>
            <button class="pagination-btn">2</button>
            <button class="pagination-btn">3</button>
            <button class="pagination-btn">Sau</button>
        </div>
    </div>
</div>

<script>
    // Filter handling
    const updateFilters = () => {
        const params = new URLSearchParams(window.location.search);
        
        // Get price ranges
        const priceFilters = document.querySelectorAll('.price-filter:checked');
        if (priceFilters.length > 0) {
            const minPrices = [];
            const maxPrices = [];
            priceFilters.forEach(filter => {
                minPrices.push(parseInt(filter.dataset.min));
                maxPrices.push(parseInt(filter.dataset.max));
            });
            params.set('priceMin', Math.min(...minPrices));
            params.set('priceMax', Math.max(...maxPrices));
        } else {
            params.delete('priceMin');
            params.delete('priceMax');
        }
        
        // Get sizes
        const sizeButtons = document.querySelectorAll('.size-filter.active');
        if (sizeButtons.length > 0) {
            const sizes = Array.from(sizeButtons).map(btn => btn.dataset.size);
            sizes.forEach((size, index) => {
                params.append('sizes', size);
            });
        } else {
            params.delete('sizes');
        }
        
        // Get colors
        const colorFilters = document.querySelectorAll('.color-filter:checked');
        if (colorFilters.length > 0) {
            const colors = Array.from(colorFilters).map(filter => filter.dataset.color);
            colors.forEach((color, index) => {
                params.append('colors', color);
            });
        } else {
            params.delete('colors');
        }
        
        // Reload page with new filters
        window.location.search = params.toString();
    };
    
    // Price filter change
    document.querySelectorAll('.price-filter').forEach(filter => {
        filter.addEventListener('change', updateFilters);
    });
    
    // Size filter toggle
    document.querySelectorAll('.size-filter').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            this.classList.toggle('active');
            updateFilters();
        });
    });
    
    // Color filter change
    document.querySelectorAll('.color-filter').forEach(filter => {
        filter.addEventListener('change', updateFilters);
    });
    
    // Sort change
    document.getElementById('sortSelect').addEventListener('change', function() {
        const params = new URLSearchParams(window.location.search);
        params.set('sort', this.value);
        window.location.search = params.toString();
    });
    
    // Clear filters
    document.getElementById('clearFilters').addEventListener('click', function() {
        window.location.href = '/Products';
    });
    
    // Restore active states from URL on page load
    document.addEventListener('DOMContentLoaded', function() {
        const params = new URLSearchParams(window.location.search);
        
        // Restore size filters
        const sizes = params.getAll('sizes');
        sizes.forEach(size => {
            const button = document.querySelector(`.size-filter[data-size="${size}"]`);
            if (button) button.classList.add('active');
        });
    });
</script>

<style>
    .size-filter.active {
        background-color: var(--primary);
        color: white;
        border-color: var(--primary);
    }
</style>
